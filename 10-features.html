<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Features</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name"></span> <span class="project-version"></span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1  current"><a href="10-features.html"><div class="inner"><span>Features</span></div></a></li><li class="depth-1 "><a href="20-installation.html"><div class="inner"><span>Installation</span></div></a></li><li class="depth-1 "><a href="25-usage.html"><div class="inner"><span>Usage</span></div></a></li><li class="depth-1 "><a href="30-customisation.html"><div class="inner"><span>Customisation</span></div></a></li><li class="depth-1 "><a href="40-diagnostics-and-logging.html"><div class="inner"><span>Diagnostics and Logging</span></div></a></li><li class="depth-1 "><a href="50-contributing.html"><div class="inner"><span>Contributing</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>limabean</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>harvest</span></div></div></li><li class="depth-3"><a href="limabean.harvest.api.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>api</span></div></a></li><li class="depth-4"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>contrib</span></div></div></li><li class="depth-5 branch"><a href="limabean.harvest.api.contrib.first-direct-csv.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>first-direct-csv</span></div></a></li><li class="depth-5"><a href="limabean.harvest.api.contrib.kiwibank-ofx.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>kiwibank-ofx</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#features" id="features"></a>Features</h1>
<p><code>limabean-harvest</code> provides the following features: - import from CSV or OFX into Beancount format - lookup primary account for import from OFX <code>acctid</code> field, or infer from filename - infer secondary accounts for postings from payees (or narrations) in existing Beancount file - construct transaction ID from OFX <code>acctid</code> anf <code>fitid</code> fields, and reject import of duplicate transactions - pair up transactions between accounts where both accounts are imported in the same group</p>
<p>The intention is that both OFX v1 and v2 import is complete and general purpose.  This also works for QFX.</p>
<p>CSV import, however, requires customising for each financial instituion according to the headers they export in CSV.  This is essentially just field-mapping.</p>
<p>The import process is governed by configuration in <a href="https://github.com/edn-format/edn">EDN</a>, as in <a href="../../test-cases/first-direct-csv/config.edn">this example</a>.</p>
<h2><a href="#import-phases" id="import-phases"></a>Import Phases</h2>
<p>There are two phases to import.</p>
<h3><a href="#phase-1-hulling" id="phase-1-hulling"></a>Phase 1 - Hulling</h3>
<p>Phase 1 import unwraps the container (OFX, CSV, whatever) into generic JSON, using <code>hull-ofx</code>, <code>hull-csv</code>, et el.</p>
<p>Differences between instituions is handled by Phase 2 configuration, with minimal (but non-zero) use of custom code.</p>
<h3><a href="#phase-2-realization" id="phase-2-realization"></a>Phase 2 - Realization</h3>
<p>Phase 2 uses a digest of a Beancount file for context, which enables:</p>
<ul>
<li>mapping of external account ID to Beancount account name via metadata in <code>open</code> directives</li>
<li>secondary account inference from payee/narration of previous transactions</li>
<li>merging of the same transaction from both ends when importing both accounts together</li>
<li>detection of duplicate imports from existing transaction IDs</li>
</ul>
<h2><a href="#transaction-ids" id="transaction-ids"></a>Transaction IDs</h2>
<p>A transaction ID is allocated to each transaction by the OFX importer, and this is used to avoid re-importing the same transactions subsequently.  The ID is written to the metadata value <code>txnid</code>, (the key is configurable).</p>
<p>The transaction ID comprises <code>acctid.fitid</code>.</p>
<h2><a href="#secondary-account-inference" id="secondary-account-inference"></a>Secondary account inference</h2>
<p>Where there are matches with payees or narrations in the Beancount file providing context, secondary accounts may be inferred.</p>
<p>If any payees are found to match then narrations are ignored, otherwise narrations are used as a fallback.</p>
<p>In case of multiple matches, all are included, along with a count of match occurences.</p>
<h2><a href="#transaction-pairing" id="transaction-pairing"></a>Transaction pairing</h2>
<p>When money is moved between accounts, the import file for each account contains a record of the transaction, which leads to a duplicate transaction traditionally requiring manual elimination.</p>
<p><code>limabean-harvest</code> has heuristics to pair up transactions which are imported in the same group, removing the need for this manual step.</p>
<p>An example of paired transactions may be seen in the <a href="../../test-cases/pairing/expected.beancount">pairing golden test output</a>.  Evidence of pairing is the presence of metadata <code>txnid2</code>, <code>payee2</code>, and <code>narration2</code>, which come from the other side of the paired transaction.</p>
<p>Pairing requires secondary account inference to have allocated a unique candidate account.</p>
<p>Pairing is performed only where the source and destination accounts and the value match, and the date is within some configurable threshold (default 3 days). The result is a single transaction with both <code>txnid</code> and <code>txnid2</code> metadata values, or a comment in the case of import files missing transaction IDs. The payee and narration from the second transaction are also preserved as <code>payee2</code> and <code>narration2</code> metadata fields.  These fields are used for account inference in subsequent imports.</p>
<p>If pairing is not happening the most likely explanation is multiple inferred secondary accounts.  The mitigation for this is to fix any references to these payees/narrations in the Beancount file, so that only one secondary account is inferred, for both ends of the candidate paired transaction.</p>
<p>The pairing window may be adjusted in the configuration with e.g. <code>:pairing {:window 4}</code> or switched off altogether with <code>:pairing nil</code>.  A pairing window of 0 means that transactions to be paired must be for the same day.</p>
</div></div></div></body></html>